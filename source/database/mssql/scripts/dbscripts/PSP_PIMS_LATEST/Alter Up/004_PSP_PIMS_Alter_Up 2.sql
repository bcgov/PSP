-- Script generated by Aqua Data Studio Schema Synchronization for MS SQL Server 2016 on Mon Jun 24 08:55:19 PDT 2024
-- Execute this script on:
-- 		PSP_PIMS_S82.00_xxx/dbo - This database/schema will be modified
-- to synchronize it with MS SQL Server 2016:
-- 		PSP_PIMS_S83.01/dbo

-- We recommend backing up the database prior to executing the script.

SET XACT_ABORT ON
GO
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE
GO
BEGIN TRANSACTION
GO
IF @@ERROR <> 0 SET NOEXEC ON
GO

-- Drop index dbo.LSTERM_LEASE_TERM_STATUS_TYPE_CODE_IDX
PRINT N'Drop index dbo.LSTERM_LEASE_TERM_STATUS_TYPE_CODE_IDX'
GO
DROP INDEX IF EXISTS [dbo].[PIMS_LEASE_PERIOD].[LSTERM_LEASE_TERM_STATUS_TYPE_CODE_IDX]
GO
IF @@ERROR <> 0 SET NOEXEC ON
GO

-- Alter table dbo.PIMS_LEASE_PERIOD
PRINT N'Alter table dbo.PIMS_LEASE_PERIOD'
GO
ALTER TABLE [dbo].[PIMS_LEASE_PERIOD] DROP CONSTRAINT IF EXISTS [LSTERM_LEASE_TERM_ID_DEF]
GO
IF @@ERROR <> 0 SET NOEXEC ON
GO
ALTER TABLE [dbo].[PIMS_LEASE_PERIOD] ADD CONSTRAINT [LSTERM_LEASE_PERIOD_ID_DEF] DEFAULT (NEXT VALUE FOR [PIMS_LEASE_TERM_ID_SEQ]) FOR [LEASE_PERIOD_ID]
GO
IF @@ERROR <> 0 SET NOEXEC ON
GO

-- Create sequence dbo.PIMS_LEASE_PERIOD_H_ID_SEQ
PRINT N'Create sequence dbo.PIMS_LEASE_PERIOD_H_ID_SEQ'
GO
CREATE SEQUENCE [dbo].[PIMS_LEASE_PERIOD_H_ID_SEQ]
	AS bigint
	START WITH 1
	INCREMENT BY 1
	MINVALUE 1
	MAXVALUE 2147483647
	NO CYCLE
	CACHE 50
GO
IF @@ERROR <> 0 SET NOEXEC ON
GO

-- Alter table dbo.PIMS_LEASE_PERIOD_HIST
PRINT N'Alter table dbo.PIMS_LEASE_PERIOD_HIST'
GO
ALTER TABLE [dbo].[PIMS_LEASE_PERIOD_HIST] DROP CONSTRAINT IF EXISTS [DF__PIMS_LEAS___LEAS__58FC18A6]
GO
IF @@ERROR <> 0 SET NOEXEC ON
GO
--ALTER TABLE [dbo].[PIMS_LEASE_PERIOD_HIST] ADD DEFAULT (NEXT VALUE FOR [PIMS_LEASE_PERIOD_H_ID_SEQ]) FOR [_LEASE_PERIOD_HIST_ID]
--GO
--IF @@ERROR <> 0 SET NOEXEC ON
--GO

-- Drop dynamically-named default constraint
PRINT N'Drop dynamically-named default constraint'
GO
DECLARE @sqlQry  VARCHAR(1000)
DECLARE @defName VARCHAR(100)
SET @defName = (SELECT obj.NAME
                FROM   SYSOBJECTS obj                          INNER JOIN
                       SYSCOLUMNS col on obj.ID = col.CDEFAULT INNER JOIN
                       SYSOBJECTS tbl on col.ID = tbl.ID
                WHERE  obj.XTYPE = 'D'
                   AND tbl.NAME = 'PIMS_LEASE_PERIOD_HIST' 
                   AND col.NAME = '_LEASE_PERIOD_HIST_ID')
SET @sqlQry = 'ALTER TABLE [dbo].[PIMS_LEASE_PERIOD_HIST] DROP CONSTRAINT IF EXISTS [' + @defName + ']'
EXEC (@sqlQry)
GO
IF @@ERROR <> 0 SET NOEXEC ON
GO

-- Create index dbo.LSTERM_LEASE_PERIOD_STATUS_TYPE_CODE_IDX
PRINT N'Create index dbo.LSTERM_LEASE_PERIOD_STATUS_TYPE_CODE_IDX'
GO
CREATE NONCLUSTERED INDEX [LSTERM_LEASE_PERIOD_STATUS_TYPE_CODE_IDX]
	ON [dbo].[PIMS_LEASE_PERIOD]([LEASE_PERIOD_STATUS_TYPE_CODE])
GO
IF @@ERROR <> 0 SET NOEXEC ON
GO

-- Drop sequence dbo.PIMS_LEASE_TERM_H_ID_SEQ
PRINT N'Drop sequence dbo.PIMS_LEASE_TERM_H_ID_SEQ'
GO
DROP SEQUENCE IF EXISTS [dbo].[PIMS_LEASE_TERM_H_ID_SEQ]
GO
IF @@ERROR <> 0 SET NOEXEC ON
GO

-- Set the new sequence value
PRINT N'Set the new sequence value'
GO
DECLARE @StartVlu bigint;
DECLARE @Qry nvarchar(max);

SET @StartVlu = (SELECT MAX(_LEASE_PERIOD_HIST_ID) + 1 FROM PIMS_LEASE_PERIOD_HIST)
SET @Qry      = 'ALTER SEQUENCE PIMS_LEASE_PERIOD_H_ID_SEQ RESTART WITH ' + CAST(@StartVlu AS NVARCHAR(20)) + ';'

EXEC SP_EXECUTESQL @Qry;
GO
IF @@ERROR <> 0 SET NOEXEC ON
GO

COMMIT TRANSACTION
GO
IF @@ERROR <> 0 SET NOEXEC ON
GO
DECLARE @Success AS BIT
SET @Success = 1
SET NOEXEC OFF
IF (@Success = 1) PRINT 'The database update succeeded'
ELSE BEGIN
   IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION
   PRINT 'The database update failed'
END
GO
