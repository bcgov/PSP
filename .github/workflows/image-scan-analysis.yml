name: Security CI

on:
  push:
    branches: [master, test, dev]
  pull_request:
    branches: [master, test, dev]
  schedule:
    - cron: '42 15 * * 5'

jobs:

  build_frontend:

    name: pims-frontend
    if: github.event.ref == 'refs/heads/master' || github.event.ref == 'refs/heads/test'
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    env:
      working-directory: ./frontend
      image-name: pims-frontend
      output-filename: pims-frontend.txt

    steps:
    - uses: actions/checkout@v1
    - name: Build PIMS Frontend
      run: |
        docker build -t ${{env.image-name}} .   
      working-directory: ${{env.working-directory}}
    - name: Scan PIMS Frontend Image with Aqua Trivy
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{env.image-name}}
        format: 'table'
        exit-code: '1'
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'
        output: ${{env.output-filename}}
    - name: Save PR number and scan results
      if: always()
      run: |
          mkdir -p ./pr_${{env.image-name}}
          echo ${{ github.event.pull_request.number }} > ./pr_${{env.image-name}}/NR
          cp ${{env.output-filename}} ./pr_${{env.image-name}}/PRBODY.txt
    - if: always()
      name: Upload artifact
      uses: actions/upload-artifact@v2
      with:
        name: ${{env.image-name}}_Scan_Report
        path: pr_${{env.image-name}}/
        retention-days: 5
        
    
  build_backend:
    
    if: always() && (github.event.ref == 'refs/heads/master' || github.event.ref == 'refs/heads/test')
    needs: build_frontend 
    name: pims-backend
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    env:
      working-directory: ./backend
      
      
    steps:
    - uses: actions/checkout@v1
    - name: Build PIMS Backend
      run: |
        docker build -t docker.io/pims-backend:${{ github.sha }} .   
      working-directory: ${{env.working-directory}}
    - name: Scan PIMS Backend Image with Aqua Trivy
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'docker.io/pims-backend:${{ github.sha }}'
        format: 'template'
        template: '@/contrib/sarif.tpl'
        exit-code: '1'
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'
        output: 'pims-backend.sarif'
    - name: Upload Trivy scan results to GitHub Security tab
      if: always()
      uses: github/codeql-action/upload-sarif@v1
      with:
        sarif_file: 'pims-backend.sarif'
    - if: always()
      name: Upload artifact
      uses: actions/upload-artifact@v2
      with:
        name: backend image scan report
        path: 'pims-backend.sarif'    
        
  build_logging:
  
    if: always() && (github.event.ref == 'refs/heads/master' || github.event.ref == 'refs/heads/test')
    needs: [build_frontend, build_backend] 
    name: logging
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    env:
      working-directory: ./openshift/4.0/templates/Logging
      
      
    steps:
    - uses: actions/checkout@v1
    - name: Build PIMS Logging
      run: |
        docker build -t docker.io/my-organization/my-app:${{ github.sha }} .   
      working-directory: ${{env.working-directory}}
    - name: Scan PIMS Logging Image with Aqua Trivy
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'docker.io/my-organization/my-app:${{ github.sha }}'
        format: 'template'
        template: '@/contrib/sarif.tpl'
        exit-code: '1'
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'
        output: 'pims-logging.sarif'
    - name: Upload Trivy scan results to GitHub Security tab
      if: always()
      uses: github/codeql-action/upload-sarif@v1
      with:
        sarif_file: 'pims-logging.sarif'
        
  build_zap:

    name: pims-zap
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
      pull-requests: write
    env:
      working-directory: ./openshift/4.0/templates/jenkins-slaves/jenkins-slave-zap
      image-name: owasp-zap
      output-filename: owasp-zap.txt

    steps:
    - uses: actions/checkout@v1
    - name: Build PIMS OWASP ZAP Image
      run: |
        docker build -t {{env.image-name}} .   
        #docker pull registry.access.redhat.com/ubi8/nodejs-14:1-35
        #docker tag registry.access.redhat.com/ubi8/nodejs-14:1-35 noejs-14:latest
        docker image ls
      working-directory: ${{env.working-directory}}
    - name: Scan jenkins-agent-zap with Aqua Trivy
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: {{env.image-name}}
        format: 'table'
        exit-code: '1'
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'
        output: {{env.output-filename}}
    - name: Save PR number and scan results
      if: always()
      run: |
          mkdir -p ./pr_{{env.image-name}}
          echo ${{ github.event.pull_request.number }} > ./pr_{{env.image-name}}/NR
          cp {{env.output-filename}} ./pr_{{env.image-name}}/PRBODY.txt
    - if: always()
      name: Upload OWASP ZAP scan artifact
      uses: actions/upload-artifact@v2
      with:
        name: {{env.image-name}}_Scan_Report
        path: pr_{{env.image-name}}/
        retention-days: 3